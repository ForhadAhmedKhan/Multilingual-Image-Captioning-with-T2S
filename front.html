<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multilingual Caption & Audio Generator</title>
  <link rel="icon" type="image/png" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #fbc2eb, #a6c1ee);
      font-family: 'Montserrat', sans-serif;
      color: #333;
      height: 100vh;
      display: flex;
    }
    .left, .right {
      flex: 1;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-y: auto;
    }
    .left {
      background-color: #fef6f9;
      border-right: 1px solid rgba(0,0,0,0.1);
    }
    .right {
      background-color: #ffffff;
    }
    h2, h3, h4 {
      margin-bottom: 20px;
      text-align: center;
      color: #6a11cb;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }
    input[type="file"], .action-btn {
      padding: 14px 20px;
      background: linear-gradient(45deg, #43e97b, #38f9d7);
      border: none;
      color: #333;
      font-weight: bold;
      font-size: 16px;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.3s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    .action-btn:hover, input[type="file"]:hover {
      transform: scale(1.08);
    }
    select {
      padding: 10px;
      border-radius: 10px;
    }
    video {
      display: none;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    #camera-controls {
      display: none;
      margin-top: 10px;
      justify-content: center;
      gap: 10px;
    }
    #capturedPreview {
      margin-top: 10px;
      width: 320px;
      height: auto;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    #uploadedImage {
    max-width: 90%;
    max-height: 300px;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    margin-top: 10px;
   }


    .badge {
      display: inline-block;
      padding: 8px 14px;
      margin: 6px;
      border-radius: 30px;
      font-size: 14px;
      color: #fff;
      background-color: #6a11cb;
    }
    audio {
      margin-top: 10px;
      outline: none;
      width: 100%;
    }
    #loader {
      display: none;
      margin-top: 20px;
      font-size: 18px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    table {
      width: 100%;
      margin-top: 20px;
      font-size: 14px;
      background: #fff;
      border-collapse: collapse;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    thead {
      background: #eee;
    }
    tr:hover {
      background-color: #f3f3f3;
    }
    .clickable {
      color: #6a11cb;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
</head>

<body>

<div class="left">
  <h2>üì∏ Multilingual Captioning with Text-to-Speech</h2>
  <div class="input-group">
    <input type="file" id="imageInput" accept="image/*" multiple onchange="resetCapturedImage()">
    <button class="action-btn" onclick="openCamera()">Open Camera</button>
    <video id="video" width="320" height="240" autoplay></video>
    <div id="camera-controls">
      <button class="action-btn" onclick="capturePhoto()">Capture</button>
      <button class="action-btn" onclick="cancelCamera()">Cancel</button>
    </div>
    <img id="capturedPreview" style="display:none;" />
    <label for="langSelect">Language:</label>
    <select id="langSelect">
      <option value="en">English</option>
      <option value="bn">Bengali</option>
      <option value="hi">Hindi</option>
      <option value="zh-cn">Chinese</option>
    </select>
    <label for="modelSelect">Model:</label>
    <select id="modelSelect">
      <option value="blip">BLIP</option>
      <option value="vit-gpt2">ViT-GPT2</option>
      <option value="blip2">BLIP-2</option>
    </select>
    <button class="action-btn" onclick="uploadImages()">Generate</button>
  </div>

  <h4>Model Comparison History:</h4>
  <table>
    <thead>
      <tr>
        <th>Image</th>
        <th>BLIP Caption</th>
        <th>Time BLIP (s)</th>
        <th>METEOR</th>
        <th>BLEU</th>
        <th>ViT-GPT2 Caption</th>
        <th>Time ViT-GPT2 (s)</th>
        <th>METEOR</th>
        <th>BLEU</th>
        <th>BLIP-2 Caption</th>
        <th>Time BLIP-2 (s)</th>
        <th>METEOR</th>
        <th>BLEU</th>
      </tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<div class="right">
  <h3>Uploaded Image:</h3>
  <img id="uploadedImage" src=""><br>
  <h3>Detected Faces:</h3>
  <div id="emotionList" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
  <h3>Caption:</h3>
  <p id="caption"></p>
  <h3>Audio:</h3>
  <audio id="audioPlayer" controls></audio>
  <div style="margin-top: 20px;">
    <button class="action-btn" id="prevBtn" style="display:none;" onclick="showPrevious()">‚óÄÔ∏è Previous</button>
    <button class="action-btn" id="nextBtn" style="display:none;" onclick="showNext()">Next ‚ñ∂Ô∏è</button>
  </div>
  <div id="loader">‚è≥ Generating...</div>
</div>

<script>
  let resultsData = [];
  let currentIndex = 0;
  let capturedFile = null;
  let modelHistory = {};
  
  async function uploadImages() {
    const input = document.getElementById('imageInput');
    const files = input.files;
    const lang = document.getElementById('langSelect').value;
    const model = document.getElementById('modelSelect').value;
  
    if (capturedFile) {
      await processCapturedImage(lang, model);
      return;
    }
  
    if (files.length === 0) return alert('Please select images or capture!');
    resultsData = [];
    currentIndex = 0;
    document.getElementById('loader').style.display = 'block';
  
    const promises = Array.from(files).map(async (file) => {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('lang', lang);
      formData.append('model', model);

  
      try{
      const response = await fetch('/generate/', { method: 'POST', body: formData });
      const data = await response.json();


      const name = file.name;
      if (!modelHistory[name]) modelHistory[name] = {};
      modelHistory[name].image_url = data.image_url;
      modelHistory[name].emotions = data.emotions;
      modelHistory[name][`${model}_caption`] = data.caption;
      modelHistory[name][`${model}_audio_url`] = data.audio_url;
      modelHistory[name][`time_${model}`] = data.model_time_only || "-";
      modelHistory[name][`${model}_meteor`] = data.meteor || "-";
      modelHistory[name][`${model}_bleu`] = data.bleu || "-";

  
      updateModelHistory();
      resultsData.push(data);
    }catch(err){
      console.error("Error parsing response", err);
    alert("Something went wrong.");
    }
  });
  
    await Promise.all(promises);
    document.getElementById('loader').style.display = 'none';
    if (resultsData.length > 0) {
      showResult(currentIndex);
    }
  }
  
  async function processCapturedImage(lang, model) {
    const formData = new FormData();
    formData.append('file', capturedFile);
    formData.append('lang', lang);
    formData.append('model', model);
  
    document.getElementById('loader').style.display = 'block';
  
    try {
      console.log("Sending request...");

      const response = await fetch('/generate/', { method: 'POST', body: formData });
      const data = await response.json();

  
      const name = "captured.png";
      resultsData = [data];
      currentIndex = 0;
      if (!modelHistory[name]) modelHistory[name] = {};
      modelHistory[name].image_url = data.image_url;
      modelHistory[name].emotions = data.emotions;
      modelHistory[name][`${model}_caption`] = data.caption;
      modelHistory[name][`${model}_audio_url`] = data.audio_url;
      modelHistory[name][`time_${model}`] = data.model_time_only || "-";
      modelHistory[name][`${model}_meteor`] = data.meteor || "-";
      modelHistory[name][`${model}_bleu`] = data.bleu || "-";
  
      updateModelHistory();
      showResult(0);
    } catch (err) {
      console.error("Error fetching captured image result:", err);
      alert("Something went wrong!");
    }
    document.getElementById('loader').style.display = 'none';
  }
  
  function updateModelHistory() {
    const tbody = document.getElementById('historyBody');
    tbody.innerHTML = '';
    Object.entries(modelHistory).forEach(([image, entry]) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${image}</td>
        <td class="clickable" onclick="updateRightPanel('${image}', 'blip')">
          ${entry.blip_caption ? entry.blip_caption.slice(0, 50) + "..." : "-"}</td>
        <td>${entry.time_blip || "-"}</td>
        <td>${entry.blip_meteor !== undefined ? entry.blip_meteor : "-"}</td>
        <td>${entry.blip_bleu !== undefined ? entry.blip_bleu : "-"}</td>
        

        <td class="clickable" onclick="updateRightPanel('${image}', 'vit-gpt2')">
          ${entry['vit-gpt2_caption'] ? entry['vit-gpt2_caption'].slice(0, 50) + "..." : "-"}</td>
        <td>${entry['time_vit-gpt2'] || "-"}</td>
        <td>${entry['vit-gpt2_meteor'] !== undefined ? entry['vit-gpt2_meteor'] : "-"}</td>
        <td>${entry['vit-gpt2_bleu'] !== undefined ? entry['vit-gpt2_bleu'] : "-"}</td>
       

        <td class="clickable" onclick="updateRightPanel('${image}', 'blip2')">
          ${entry.blip2_caption ? entry.blip2_caption.slice(0, 50) + "..." : "-"}</td>
        <td>${entry.time_blip2 || "-"}</td>
        <td>${entry.blip2_meteor !== undefined ? entry.blip2_meteor : "-"}</td>
        <td>${entry.blip2_bleu !== undefined ? entry.blip2_bleu : "-"}</td>
        
      `;
      tbody.appendChild(row);
    });
  }
  
  function updateRightPanel(imageName, model) {
    const entry = modelHistory[imageName];
    if (!entry) return;
    document.getElementById('uploadedImage').src = entry.image_url;
    document.getElementById('caption').innerText = entry[`${model}_caption`] || '';
    document.getElementById('audioPlayer').src = entry[`${model}_audio_url`] || '';
  
    const emotionList = document.getElementById('emotionList');
    emotionList.innerHTML = '';
    (entry.emotions || []).forEach(face => {
      const span = document.createElement('span');
      span.innerText = face;
      span.className = "badge";
      emotionList.appendChild(span);
    });
  }
  
  function showResult(index) {
    const data = resultsData[index];
    document.getElementById('uploadedImage').src = data.image_url;
    document.getElementById('caption').innerText = data.caption;
    document.getElementById('audioPlayer').src = data.audio_url;
  
    const emotionList = document.getElementById('emotionList');
    emotionList.innerHTML = '';
    data.emotions.forEach(face => {
      const span = document.createElement('span');
      span.innerText = face;
      span.className = "badge";
      emotionList.appendChild(span);
    });
  
    document.getElementById('prevBtn').style.display = resultsData.length > 1 ? 'inline-block' : 'none';
    document.getElementById('nextBtn').style.display = resultsData.length > 1 ? 'inline-block' : 'none';
    document.getElementById('prevBtn').disabled = index === 0;
    document.getElementById('nextBtn').disabled = index === resultsData.length - 1;
  }
  
  function showNext() {
    if (currentIndex < resultsData.length - 1) {
      currentIndex++;
      showResult(currentIndex);
    }
  }
  
  function showPrevious() {
    if (currentIndex > 0) {
      currentIndex--;
      showResult(currentIndex);
    }
  }
  
  function resetCapturedImage() {
    document.getElementById('capturedPreview').src = '';
    document.getElementById('capturedPreview').style.display = 'none';
    capturedFile = null;
  }
  
  function openCamera() {
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        const video = document.getElementById('video');
        video.srcObject = stream;
        video.style.display = 'block';
        document.getElementById('camera-controls').style.display = 'flex';
      })
      .catch(err => alert("Camera error: " + err));
  }
  
  function capturePhoto() {
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(blob => {
      capturedFile = new File([blob], "captured.png", { type: 'image/png' });
      document.getElementById('capturedPreview').src = URL.createObjectURL(blob);
      document.getElementById('capturedPreview').style.display = 'block';
      document.getElementById('imageInput').value = '';
      stopCamera();
    });
  }
  
  function stopCamera() {
    const video = document.getElementById('video');
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(track => track.stop());
      video.srcObject = null;
    }
    video.style.display = 'none';
    document.getElementById('camera-controls').style.display = 'none';
  }
  
  function cancelCamera() {
    stopCamera();
  }
  </script>
  

</body>
</html>
